<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Costa Rica a mi Manera</title>

    <meta property="og:title" content="Costa Rica a mi Manera">
    <meta property="og:description" content="Mapa personal para guardar y explorar lugares en Costa Rica.">
    <meta property="og:image" content="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjQ9ADzb_dnlNDhLgUoEUlexpbTnDUhmFboAN5nfYUETmdAPF70C6SvUwTC7qBuAQgLPCNqswsd_fCMtlGoujKQg9SOGABHkzkHE1T843j-d4xbPRGG3YAGFPz2SWiI7l01jBm9tpjrLFxO_rS4lZZ-RSbqQFEkMVQhyTvGAeP5EeU57ijd0xBWHkBdL64/w351-h530/250c9ces-1920.jpg">
    <meta property="og:type" content="website">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- Fuente Inter y Estilos Personalizados -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        // Configuraci√≥n de Tailwind con paleta de colores personalizada
        tailwind.config = {
             theme: { 
                 extend: { 
                     fontFamily: { sans: ['Inter', 'sans-serif'] },
                     colors: {
                         brand: {
                             dark: '#0f172a', // Slate 900
                             primary: '#0d9488', // Teal 600
                             secondary: '#14b8a6', // Teal 500
                             accent: '#f59e0b', // Amber 500
                             bg: '#f8fafc' // Slate 50
                         }
                     }
                 } 
             }
        }
    </script>

    <style>
        /* Estilos generales */
        #map {
            height: calc(100vh - 4rem);
            background-color: #e5e7eb;
            z-index: 10;
        }
        body { overflow: hidden; } 

        /* Marcador ubicaci√≥n actual */
        .current-location-marker {
            background-color: #0d9488; /* Teal 600 */
            width: 18px; height: 18px; border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 0 3px #0d9488;
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(13, 148, 136, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(13, 148, 136, 0); }
            100% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(13, 148, 136, 0); }
        }

        /* --- ESTILOS DE POPUP PERSONALIZADOS (Tarjeta Moderna) --- */
        .custom-popup .leaflet-popup-content-wrapper {
            padding: 0;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border: none;
        }
        .custom-popup .leaflet-popup-content {
            margin: 0 !important;
            width: 300px !important;
            line-height: 1.6;
        }
        .custom-popup .leaflet-popup-tip {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .custom-popup .leaflet-popup-close-button {
            top: 12px !important;
            right: 12px !important;
            color: white !important;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
            border-radius: 50%;
            width: 28px !important;
            height: 28px !important;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px !important;
            padding: 0 !important;
            z-index: 20;
            transition: background 0.2s;
        }
        .custom-popup .leaflet-popup-close-button:hover {
            background: rgba(0,0,0,0.6);
        }
        .custom-popup-no-photo .leaflet-popup-close-button {
            color: #475569 !important;
            background: #f1f5f9;
        }

        /* Bot√≥n "Ver Todo" estilo moderno */
        .leaflet-control-custom {
            background-color: white;
            border: none;
            border-radius: 8px;
            width: 36px;
            height: 36px;
            line-height: 36px;
            text-align: center;
            cursor: pointer;
            color: #334155;
            font-size: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }
        .leaflet-control-custom:hover {
            background-color: #f8fafc;
            color: #0f172a;
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* Scrollbar estilizado */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }
        
        /* Estrellas */
        .star-rating .fa-star { cursor: pointer; transition: color 0.1s; }
        .star-rating .fa-star.selected { color: #f59e0b; } /* brand-accent */
        .star-rating .fa-star:not(.selected) { color: #cbd5e1; }

        /* Icono marcador */
        .custom-marker-icon { text-align: center; transition: transform 0.2s; }
        .custom-marker-icon:hover { transform: scale(1.1) translateY(-2px); }
        .custom-marker-icon i { filter: drop-shadow(0 4px 3px rgba(0,0,0,0.25)); }
        
        /* Animaci√≥n Shimmer para carga AI */
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        body.modal-open { overflow: hidden; }
    </style>
</head>
<body class="font-sans flex flex-col h-screen bg-brand-bg text-slate-800">

    <!-- Header Profesional -->
    <header class="bg-brand-dark shadow-lg px-6 flex justify-between items-center z-20 h-16 border-b border-slate-800">
        <div class="flex items-center gap-4">
            <button id="toggle-list-btn" class="text-slate-300 hover:text-white p-2 rounded-lg hover:bg-slate-800 transition duration-200">
                <i class="fas fa-bars fa-lg"></i>
            </button>
            <div class="flex items-center gap-2">
                <i class="fas fa-map-marked-alt text-brand-primary text-xl"></i>
                <h1 class="text-lg md:text-xl font-bold text-white tracking-tight">Costa Rica <span class="font-light text-slate-300">a mi Manera</span></h1>
            </div>
        </div>
        
        <button id="locate-me-btn" class="bg-slate-800 text-brand-secondary hover:bg-brand-primary hover:text-white px-4 py-2 rounded-full text-sm font-medium transition duration-200 flex items-center gap-2 shadow-sm border border-slate-700">
            <i class="fas fa-crosshairs"></i> <span class="hidden md:inline">Mi Ubicaci√≥n</span>
        </button>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        <!-- Sidebar Moderna -->
        <aside id="sidebar" class="absolute md:relative top-0 left-0 h-full w-full md:w-96 bg-white shadow-2xl z-30 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col border-r border-slate-200">
             
             <!-- Encabezado Sidebar -->
             <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-white">
                 <div>
                     <h2 class="text-xl font-bold text-slate-800">Explorar</h2>
                     <p class="text-xs text-slate-500 mt-0.5">Tus rincones favoritos guardados</p>
                 </div>
                 <button id="close-sidebar-btn" class="md:hidden text-slate-400 hover:text-red-500 p-2 rounded-full hover:bg-slate-50 transition">
                     <i class="fas fa-times fa-lg"></i>
                 </button>
             </div>
             
             <!-- Buscador Estilizado -->
             <div class="px-5 pt-5 pb-2">
                 <div class="relative group">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-slate-400 group-focus-within:text-brand-primary transition"></i>
                    </div>
                    <input type="text" id="search-input" class="w-full pl-10 pr-4 py-2.5 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white focus:ring-2 focus:ring-brand-primary/20 focus:border-brand-primary text-sm transition-all shadow-sm outline-none" placeholder="Buscar restaurantes, playas...">
                 </div>
             </div>

             <!-- Filtros (Pills) -->
             <div class="px-5 pb-4 border-b border-slate-100">
                 <label for="category-filter" class="block text-xs font-semibold text-slate-500 mb-2 uppercase tracking-wide">Categor√≠a</label>
                 <div class="relative">
                     <select id="category-filter" class="w-full p-2.5 border border-slate-200 rounded-lg bg-white text-sm focus:ring-2 focus:ring-brand-primary/20 focus:border-brand-primary outline-none cursor-pointer text-slate-700 font-medium">
                         <option value="all">üìç Ver Todo</option>
                         <option value="Restaurante">üçΩÔ∏è Restaurantes</option>
                         <option value="Parque">üå≥ Parques Nacionales</option>
                         <option value="Playa">üèñÔ∏è Playas</option>
                         <option value="Tienda">üõçÔ∏è Tiendas</option>
                         <option value="Hotel">üè® Hoteles</option>
                         <option value="Mirador">üåÑ Miradores</option>
                         <option value="Otro">üîñ Otros</option>
                     </select>
                 </div>
             </div>

             <!-- Lista de Lugares -->
             <ul id="places-list" class="flex-1 overflow-y-auto p-3 space-y-3 bg-slate-50 custom-scrollbar">
                 <li class="flex flex-col items-center justify-center h-40 text-slate-400">
                     <i class="fas fa-map-marked-alt text-4xl mb-3 opacity-30"></i>
                     <span class="text-sm font-medium">Sin lugares guardados</span>
                 </li>
             </ul>

             <!-- AI Analysis Button (New) -->
             <div class="px-4 py-2 bg-gradient-to-r from-brand-primary to-brand-secondary">
                 <button id="ai-guide-btn" class="w-full flex items-center justify-center gap-2 text-white font-bold py-2 px-4 rounded-lg text-sm transition hover:opacity-90 shadow-md">
                     <i class="fas fa-sparkles"></i> Gu√≠a Inteligente
                 </button>
             </div>

             <!-- Footer Sidebar (Botones Acci√≥n) -->
             <div class="p-4 border-t border-slate-100 bg-white grid grid-cols-2 gap-3">
                 <button id="export-btn" class="flex items-center justify-center gap-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-2.5 px-4 rounded-xl text-sm transition duration-200">
                     <i class="fas fa-download text-slate-500"></i> Exportar
                 </button>
                 <div class="relative">
                     <button id="import-btn" class="w-full flex items-center justify-center gap-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-2.5 px-4 rounded-xl text-sm transition duration-200">
                         <i class="fas fa-upload text-slate-500"></i> Importar
                     </button>
                     <input type="file" id="import-file" accept=".json" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                 </div>
             </div>
        </aside>

        <div id="map" class="flex-1 shadow-inner relative">
             <p id="map-error-message" class="absolute inset-0 flex items-center justify-center bg-slate-100 text-red-600 font-semibold z-50 hidden">Error al cargar el mapa. Verifica tu conexi√≥n.</p>
        </div>
    </div>

    <!-- Modal Moderno -->
    <div id="place-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex flex-col sm:items-center sm:justify-center z-50 hidden sm:p-4 transition-all">
        <div class="w-full h-full bg-white sm:rounded-2xl sm:shadow-2xl sm:max-w-lg md:max-w-xl sm:max-h-[90vh] flex flex-col overflow-hidden transform transition-all scale-100">
             <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-10">
                  <h3 id="modal-title" class="text-xl font-bold text-slate-800">Detalles del Lugar</h3>
                  <button type="button" id="cancel-modal-btn-header" class="text-slate-400 hover:text-slate-600 p-1 rounded-full hover:bg-slate-100 transition">
                      <i class="fas fa-times fa-lg"></i>
                  </button>
             </div>

             <div class="modal-content-area overflow-y-auto flex-1 p-6 custom-scrollbar bg-slate-50/50">
                 <form id="place-form" class="space-y-5">
                     <input type="hidden" id="place-id">
                     <input type="hidden" id="place-lat">
                     <input type="hidden" id="place-lng">

                     <!-- Nombre -->
                     <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                         <label for="place-name" class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">Nombre del Lugar</label>
                         <input type="text" id="place-name" required class="block w-full px-0 py-1 border-none focus:ring-0 text-lg font-bold text-slate-800 placeholder-slate-300 bg-transparent" placeholder="Ej. Playa Manuel Antonio">
                     </div>

                     <!-- Categor√≠a y Fecha (Grid) -->
                     <div class="grid grid-cols-2 gap-4">
                         <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100">
                             <label for="place-category" class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">Categor√≠a</label>
                             <select id="place-category" class="block w-full px-0 py-1 border-none focus:ring-0 text-sm font-medium text-slate-700 bg-transparent cursor-pointer">
                                 <option>Restaurante</option> <option>Parque</option> <option>Playa</option>
                                 <option>Tienda</option> <option>Hotel</option> <option>Mirador</option>
                                 <option>Otro</option>
                             </select>
                         </div>
                         <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100">
                             <label for="place-visited" class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">Fecha Visita</label>
                             <input type="date" id="place-visited" class="block w-full px-0 py-1 border-none focus:ring-0 text-sm font-medium text-slate-700 bg-transparent" style="color-scheme: light;"> 
                         </div>
                     </div>

                     <!-- Foto URL -->
                     <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                         <label for="place-photo" class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">Foto (URL)</label>
                         <div class="flex items-center gap-2">
                             <i class="fas fa-link text-slate-400 text-sm"></i>
                             <input type="url" id="place-photo" class="block w-full px-0 py-1 border-none focus:ring-0 text-sm text-slate-700 placeholder-slate-300 bg-transparent" placeholder="https://...">
                         </div>
                     </div>

                     <!-- Calificaci√≥n -->
                     <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 text-center">
                         <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-2">Tu Calificaci√≥n</label>
                         <div id="place-rating" class="flex justify-center space-x-2 star-rating text-3xl"> 
                             <i class="far fa-star" data-value="1"></i> <i class="far fa-star" data-value="2"></i>
                             <i class="far fa-star" data-value="3"></i> <i class="far fa-star" data-value="4"></i>
                             <i class="far fa-star" data-value="5"></i>
                         </div>
                         <input type="hidden" id="place-rating-value" value="0">
                     </div>

                     <!-- Notas (con bot√≥n AI) -->
                     <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 relative group">
                         <div class="flex justify-between items-center mb-1">
                             <label for="place-notes" class="block text-xs font-bold text-slate-500 uppercase tracking-wide">Notas Personales</label>
                             <button type="button" id="magic-notes-btn" class="text-xs bg-gradient-to-r from-brand-primary to-brand-secondary text-white px-2 py-1 rounded-md shadow-sm hover:opacity-90 transition flex items-center gap-1" title="Generar descripci√≥n con IA">
                                 <i class="fas fa-sparkles"></i> Rese√±a M√°gica
                             </button>
                         </div>
                         <textarea id="place-notes" rows="3" class="block w-full px-0 py-1 border-none focus:ring-0 text-sm text-slate-700 placeholder-slate-300 bg-transparent resize-none" placeholder="¬øQu√© te gust√≥ m√°s? ¬øPrecios?"></textarea>
                          <p id="address-loading-message" class="text-xs text-brand-primary mt-2 hidden animate-pulse font-medium">üìç Obteniendo direcci√≥n...</p>
                     </div>
                 </form>
             </div>

             <!-- Botones Modal -->
             <div class="p-5 border-t border-slate-100 bg-white grid gap-3">
                  <button type="submit" form="place-form" id="save-place-btn" class="w-full bg-brand-primary hover:bg-brand-secondary text-white font-bold py-3.5 px-4 rounded-xl transition duration-200 text-base shadow-lg shadow-brand-primary/30 transform active:scale-95"> 
                      Guardar Lugar 
                  </button>
                  
                  <div class="grid grid-cols-2 gap-3" id="edit-actions">
                      <button type="button" id="share-place-btn" class="flex items-center justify-center gap-2 bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-3 px-4 rounded-xl text-sm transition"> 
                          <i class="fas fa-share-alt"></i> Compartir 
                      </button>
                      <button type="button" id="delete-place-btn" class="flex items-center justify-center gap-2 bg-red-50 hover:bg-red-100 text-red-600 font-semibold py-3 px-4 rounded-xl text-sm transition"> 
                          <i class="fas fa-trash-alt"></i> Eliminar 
                      </button>
                  </div>
                  
                  <a id="modal-directions-btn" href="#" target="_blank" class="w-full flex items-center justify-center gap-2 text-brand-primary hover:text-brand-secondary font-medium py-2 text-sm transition hidden"> 
                      <i class="fas fa-external-link-alt"></i> Ver en Google Maps 
                  </a>
             </div>
         </div>
    </div>

    <!-- AI Result Modal -->
    <div id="ai-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden">
            <div class="p-5 bg-gradient-to-r from-brand-primary to-brand-secondary text-white flex justify-between items-center">
                <h3 class="font-bold text-lg"><i class="fas fa-robot mr-2"></i>Gu√≠a Inteligente</h3>
                <button id="close-ai-modal" class="text-white/80 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div id="ai-content" class="p-6 text-slate-700 text-sm leading-relaxed max-h-[60vh] overflow-y-auto">
                <!-- Content goes here -->
            </div>
        </div>
    </div>

    <!-- Leaflet JS & Plugins -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script>
        const apiKey = ""; // La API Key se inyecta autom√°ticamente

        // --- Variables Globales ---
        let map; 
        let places = []; 
        let markers = {}; 
        let markersClusterGroup;
        let currentEditingId = null; 
        let currentLocationMarker = null;
        const COSTA_RICA_CENTER = [9.7489, -83.7534]; 
        const DEFAULT_ZOOM = 8; 
        const LOCAL_STORAGE_KEY = 'costaRicaPlacesApp'; 
        let osmTile, satelliteTile, topoTile, cartoLabels, darkTile, voyagerTile; 
        let layerControl;

        // Mapeo de colores para las categor√≠as (Tailwind colors)
        const categoryColors = {
            'Restaurante': 'text-orange-500',
            'Parque': 'text-emerald-600',
            'Playa': 'text-cyan-500',
            'Tienda': 'text-purple-500',
            'Hotel': 'text-indigo-500',
            'Mirador': 'text-amber-500',
            'Otro': 'text-slate-500'
        };

        // Elementos DOM
        const bodyElement = document.body;
        const sidebar = document.getElementById('sidebar');
        const toggleListBtn = document.getElementById('toggle-list-btn');
        const closeSidebarBtn = document.getElementById('close-sidebar-btn');
        const locateMeBtn = document.getElementById('locate-me-btn');
        const placesListElement = document.getElementById('places-list');
        const categoryFilter = document.getElementById('category-filter');
        const searchInput = document.getElementById('search-input');
        const placeModal = document.getElementById('place-modal');
        const placeForm = document.getElementById('place-form');
        const modalTitle = document.getElementById('modal-title');
        const placeIdInput = document.getElementById('place-id');
        const placeLatInput = document.getElementById('place-lat');
        const placeLngInput = document.getElementById('place-lng');
        const placeNameInput = document.getElementById('place-name');
        const placePhotoInput = document.getElementById('place-photo');
        const placeNotesInput = document.getElementById('place-notes');
        const addressLoadingMessage = document.getElementById('address-loading-message');
        const placeCategoryInput = document.getElementById('place-category');
        const placeRatingElement = document.getElementById('place-rating');
        const placeRatingValueInput = document.getElementById('place-rating-value');
        const placeVisitedInput = document.getElementById('place-visited');
        const savePlaceBtn = document.getElementById('save-place-btn');
        const cancelModalBtnHeader = document.getElementById('cancel-modal-btn-header');
        const deletePlaceBtn = document.getElementById('delete-place-btn');
        const sharePlaceBtn = document.getElementById('share-place-btn');
        const editActionsDiv = document.getElementById('edit-actions');
        const modalDirectionsBtn = document.getElementById('modal-directions-btn');
        const exportBtn = document.getElementById('export-btn');
        const importBtn = document.getElementById('import-btn');
        const importFileInput = document.getElementById('import-file');
        const mapErrorMessage = document.getElementById('map-error-message');
        
        // AI Elements
        const magicNotesBtn = document.getElementById('magic-notes-btn');
        const aiGuideBtn = document.getElementById('ai-guide-btn');
        const aiModal = document.getElementById('ai-modal');
        const aiContent = document.getElementById('ai-content');
        const closeAiModalBtn = document.getElementById('close-ai-modal');

        // --- Gemini Helper ---
        async function callGemini(prompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }]
            };

            // Retry logic
            const delays = [1000, 2000, 4000];
            for (let i = 0; i <= delays.length; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "No se pudo generar respuesta.";
                } catch (error) {
                    if (i === delays.length) throw error;
                    await new Promise(r => setTimeout(r, delays[i]));
                }
            }
        }

        // --- AI Features ---

        async function generateMagicNotes() {
            const name = placeNameInput.value.trim();
            const category = placeCategoryInput.value;
            const lat = placeLatInput.value;
            const lng = placeLngInput.value;

            if (!name) {
                alert("Por favor, escribe el nombre del lugar primero.");
                placeNameInput.focus();
                return;
            }

            // UI Loading
            const originalText = magicNotesBtn.innerHTML;
            magicNotesBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creando...';
            magicNotesBtn.disabled = true;
            placeNotesInput.placeholder = "Gemini est√° escribiendo una rese√±a m√°gica para ti...";

            const prompt = `Act√∫a como un experto gu√≠a tur√≠stico de Costa Rica. Escribe una descripci√≥n breve (m√°ximo 40 palabras), atractiva y √∫til sobre el lugar llamado "${name}" que es un/a "${category}" ubicado cerca de las coordenadas ${lat}, ${lng}. Incluye un dato curioso o un consejo de viaje. Responde en espa√±ol plano (sin markdown).`;

            try {
                const text = await callGemini(prompt);
                placeNotesInput.value = text.trim();
            } catch (error) {
                console.error(error);
                alert("Hubo un error al conectar con la IA. Int√©ntalo de nuevo.");
            } finally {
                magicNotesBtn.innerHTML = originalText;
                magicNotesBtn.disabled = false;
                placeNotesInput.placeholder = "¬øQu√© te gust√≥ m√°s? ¬øPrecios?";
            }
        }

        async function generateTripAdvice() {
            if (places.length === 0) {
                alert("Guarda algunos lugares primero para que la IA pueda analizar tus gustos.");
                return;
            }

            // Show modal loading
            aiModal.classList.remove('hidden');
            aiContent.innerHTML = `
                <div class="flex flex-col items-center justify-center py-8">
                    <div class="w-12 h-12 rounded-full loading-shimmer mb-4"></div>
                    <p class="text-slate-500 font-medium">Analizando tu mapa y buscando joyas ocultas...</p>
                </div>
            `;

            // Prepare summary
            const placesSummary = places.map(p => `${p.name} (${p.category})`).join(", ");
            
            const prompt = `Analiza esta lista de lugares que un viajero ha guardado en su mapa de Costa Rica: ${placesSummary}. 
            1. Define su "Estilo de Viajero" en 3 palabras (ej. "Amante de la Playa").
            2. Recomienda UNA "Joya Oculta" (lugar poco conocido) que le gustar√≠a y que NO est√° en la lista. Explica por qu√© en una frase.
            3. Da un consejo general de seguridad o clima para su tipo de viaje.
            Usa formato HTML simple (h4, p, strong) para la respuesta.`;

            try {
                const text = await callGemini(prompt);
                // Convert markdown-ish to HTML if needed, but we asked for HTML. 
                // Simple cleanup for bolding if Gemini uses **
                const formattedHtml = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                aiContent.innerHTML = formattedHtml;
            } catch (error) {
                aiContent.innerHTML = `<p class="text-red-500 text-center">No se pudo obtener el consejo. Intenta m√°s tarde.</p>`;
            }
        }

        // --- Inicializaci√≥n ---
        function initMap() {
            if (typeof L === 'undefined') {
                mapErrorMessage.classList.remove('hidden');
                return;
            }
            try {
                // Iniciar mapa
                map = L.map('map', { zoomControl: false }).setView(COSTA_RICA_CENTER, DEFAULT_ZOOM);
                
                // Mover controles de zoom a una posici√≥n m√°s limpia
                L.control.zoom({ position: 'bottomright' }).addTo(map);

                // Capas
                osmTile = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '¬© OSM' });
                satelliteTile = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '¬© Esri' });
                darkTile = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '¬© CARTO', subdomains: 'abcd', maxZoom: 20 });
                voyagerTile = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '¬© CARTO', subdomains: 'abcd', maxZoom: 20 });

                voyagerTile.addTo(map); // Capa Voyager por defecto (m√°s limpia y moderna)

                // Clustering
                if (L.markerClusterGroup) {
                    markersClusterGroup = L.markerClusterGroup({
                        showCoverageOnHover: false,
                        zoomToBoundsOnClick: true,
                        spiderfyOnMaxZoom: true,
                        removeOutsideVisibleBounds: true,
                    });
                    map.addLayer(markersClusterGroup);
                }

                // Control de capas
                const baseMaps = { "Moderno": voyagerTile, "Oscuro": darkTile, "Sat√©lite": satelliteTile, "Cl√°sico": osmTile };
                L.control.layers(baseMaps, null, { position: 'bottomright' }).addTo(map);

                // Escala
                L.control.scale({ imperial: false, position: 'bottomleft' }).addTo(map);

                // Bot√≥n Ver Todo
                const fitBoundsControl = L.Control.extend({
                    options: { position: 'topright' },
                    onAdd: function(map) {
                        const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                        container.innerHTML = '<i class="fas fa-expand"></i>';
                        container.title = "Ver todo el mapa";
                        container.onclick = function() {
                            if (places.length > 0) {
                                const latLngs = places.map(p => [p.lat, p.lng]);
                                map.fitBounds(latLngs, { padding: [50, 50], animate: true, duration: 1 });
                            } else {
                                map.flyTo(COSTA_RICA_CENTER, DEFAULT_ZOOM);
                            }
                        };
                        return container;
                    }
                });
                map.addControl(new fitBoundsControl());

                map.on('click', onMapClick);
                loadPlaces();

            } catch (error) {
                console.error(error);
                mapErrorMessage.classList.remove('hidden');
            }
        }

        // --- L√≥gica de Negocio ---

        function openModal() {
            placeModal.classList.remove('hidden');
            setTimeout(() => { // Peque√±a animaci√≥n de entrada
                placeModal.firstElementChild.classList.remove('scale-95', 'opacity-0');
                placeModal.firstElementChild.classList.add('scale-100', 'opacity-100');
            }, 10);
            bodyElement.classList.add('modal-open');
        }

        function closeModalAndReset() {
            placeModal.firstElementChild.classList.remove('scale-100', 'opacity-100');
            placeModal.firstElementChild.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                placeModal.classList.add('hidden');
                bodyElement.classList.remove('modal-open');
                currentEditingId = null;
                addressLoadingMessage.classList.add('hidden');
                placeNotesInput.classList.remove('hidden');
                placeNotesInput.placeholder = "¬øQu√© te gust√≥ m√°s? ¬øPrecios?";
                modalDirectionsBtn.classList.add('hidden');
                placeForm.reset();
                resetRatingStars();
            }, 200); // Esperar a que termine la transici√≥n
        }

        function onMapClick(e) {
            const { lat, lng } = e.latlng;
            openModalForNewPlace(lat, lng);
        }

        async function fetchAddressDetails(lat, lng) {
            // Estrategia de fallback robusta
            try {
                // Intento 1: Nominatim
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}&accept-language=es&addressdetails=1`);
                if(res.ok) return await res.json();
                throw new Error("Nominatim failed");
            } catch (e) {
                try {
                    // Intento 2: BigDataCloud
                    const res2 = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=es`);
                    if(res2.ok) {
                        const data = await res2.json();
                        return { display_name: `${data.locality || ''}, ${data.principalSubdivision || ''}, ${data.countryName || ''}` };
                    }
                } catch(e2) {
                    return null;
                }
            }
            return null;
        }

        function getCurrentDateString() {
            return new Date().toISOString().split('T')[0];
        }

        async function openModalForNewPlace(lat, lng) {
            currentEditingId = null;
            placeForm.reset();
            resetRatingStars();
            
            // Configurar UI para Nuevo
            modalTitle.textContent = 'Nuevo Descubrimiento';
            savePlaceBtn.textContent = 'Guardar Lugar';
            editActionsDiv.classList.add('hidden'); // Ocultar borrar/compartir
            modalDirectionsBtn.classList.add('hidden');
            
            placeIdInput.value = '';
            placeLatInput.value = lat;
            placeLngInput.value = lng;
            placeVisitedInput.value = getCurrentDateString();
            
            addressLoadingMessage.classList.remove('hidden');
            openModal();

            // Buscar direcci√≥n
            const addressData = await fetchAddressDetails(lat, lng);
            addressLoadingMessage.classList.add('hidden');
            
            if (addressData && addressData.display_name) {
                // Sugerencia sutil en las notas
                placeNotesInput.value = `üìç ${addressData.display_name}\n`;
            }
        }

        function openModalForEditing(placeId) {
            const place = places.find(p => p.id === placeId);
            if (!place) return;

            currentEditingId = placeId;
            placeForm.reset();
            resetRatingStars();
            addressLoadingMessage.classList.add('hidden');

            // Configurar UI para Editar
            modalTitle.textContent = 'Editar Detalle';
            savePlaceBtn.textContent = 'Guardar Cambios';
            editActionsDiv.classList.remove('hidden'); // Mostrar borrar/compartir
            
            placeIdInput.value = place.id;
            placeLatInput.value = place.lat;
            placeLngInput.value = place.lng;
            placeNameInput.value = place.name;
            placePhotoInput.value = place.photoUrl || '';
            placeNotesInput.value = place.notes || '';
            placeCategoryInput.value = place.category || 'Otro';
            placeVisitedInput.value = place.visitedDate || '';
            setRatingStars(place.rating || 0);

            const directionsUrl = `https://www.google.com/maps/dir/?api=1&destination=${place.lat},${place.lng}`;
            modalDirectionsBtn.href = directionsUrl;
            modalDirectionsBtn.classList.remove('hidden');

            openModal();
        }

        function savePlace(event) {
            event.preventDefault();
            const id = placeIdInput.value || `place_${Date.now()}`;
            const lat = parseFloat(placeLatInput.value);
            const lng = parseFloat(placeLngInput.value);
            const name = placeNameInput.value.trim();
            const photoUrl = placePhotoInput.value.trim();
            const notes = placeNotesInput.value.trim();
            const category = placeCategoryInput.value;
            const rating = parseInt(placeRatingValueInput.value, 10);
            const visitedDate = placeVisitedInput.value;

            if (!name) {
                placeNameInput.classList.add('ring-2', 'ring-red-500');
                placeNameInput.focus();
                return;
            } else {
                placeNameInput.classList.remove('ring-2', 'ring-red-500');
            }

            const placeData = { id, lat, lng, name, photoUrl, notes, category, rating, visitedDate };

            if (currentEditingId) {
                const index = places.findIndex(p => p.id === currentEditingId);
                if (index > -1) places[index] = placeData;
            } else {
                places.push(placeData);
            }

            savePlacesToLocalStorage();
            renderPlaces();
            closeModalAndReset();
        }

        function deletePlace() {
            if (!currentEditingId) return;
            if (confirm(`¬øEliminar "${placeNameInput.value}" de tu mapa?`)) {
                places = places.filter(p => p.id !== currentEditingId);
                savePlacesToLocalStorage();
                renderPlaces();
                closeModalAndReset();
            }
        }

        function sharePlace() {
            if (!currentEditingId || !('share' in navigator)) {
                alert("Tu navegador no soporta compartir nativamente.");
                return;
            }
            const place = places.find(p => p.id === currentEditingId);
            navigator.share({
                title: place.name,
                text: `¬°Mira este lugar en Costa Rica!: ${place.name}`,
                url: `https://www.google.com/maps/search/?api=1&query=${place.lat},${place.lng}`
            }).catch(console.error);
        }

        function savePlacesToLocalStorage() {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(places));
        }

        function loadPlaces() {
            const stored = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (stored) {
                try {
                    places = JSON.parse(stored);
                    if (!Array.isArray(places)) places = [];
                } catch (e) { places = []; }
            }
            renderPlaces();
        }

        function renderPlaces() {
            if (markersClusterGroup) markersClusterGroup.clearLayers();
            markers = {};
            placesListElement.innerHTML = '';

            const filterCategory = categoryFilter.value;
            const searchTerm = searchInput.value.toLowerCase().trim();

            const filteredPlaces = places.filter(place => {
                const matchesCategory = filterCategory === 'all' || place.category === filterCategory;
                const matchesSearch = place.name.toLowerCase().includes(searchTerm) || (place.notes && place.notes.toLowerCase().includes(searchTerm));
                return matchesCategory && matchesSearch;
            });

            if (filteredPlaces.length === 0) {
                placesListElement.innerHTML = `
                    <li class="flex flex-col items-center justify-center h-48 text-slate-400">
                        <i class="fas fa-search-location text-3xl mb-3 opacity-30"></i>
                        <span class="text-sm font-medium">No se encontraron lugares</span>
                    </li>`;
            } else {
                filteredPlaces.forEach(place => {
                    // Crear Marcador
                    const marker = L.marker([place.lat, place.lng], { icon: createCustomIcon(place.category) });
                    
                    // Crear Popup Contenido
                    let popupHtml = `<div class="font-sans">`;
                    
                    if (place.photoUrl) {
                        popupHtml += `<div class="h-32 w-full bg-slate-100 relative">
                                        <img src="${place.photoUrl}" class="w-full h-full object-cover" onerror="this.style.display='none'">
                                        <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>
                                        <span class="absolute bottom-2 left-3 text-white font-bold text-sm shadow-sm">${place.category}</span>
                                      </div>`;
                    } else {
                        popupHtml += `<div class="h-16 w-full bg-brand-primary flex items-center justify-center">
                                        <i class="fas fa-map-marker-alt text-white/50 text-3xl"></i>
                                      </div>`;
                    }

                    popupHtml += `<div class="p-4">
                                    <h3 class="text-lg font-bold text-slate-800 leading-tight mb-1">${place.name}</h3>
                                    ${!place.photoUrl ? `<span class="text-xs font-semibold text-brand-primary uppercase tracking-wide block mb-2">${place.category}</span>` : ''}
                                    
                                    ${place.rating > 0 ? `<div class="text-brand-accent text-sm mb-2">${'‚òÖ'.repeat(place.rating)}${'<span class="text-slate-200">‚òÖ</span>'.repeat(5 - place.rating)}</div>` : ''}
                                    
                                    ${place.notes ? `<p class="text-sm text-slate-600 line-clamp-3 mb-3 leading-relaxed">${place.notes}</p>` : ''}
                                    
                                    <button class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-2 rounded-lg text-xs transition uppercase tracking-wide" onclick="openModalForEditing('${place.id}')">
                                        Ver Detalles
                                    </button>
                                  </div>
                                </div>`;

                    const popupOptions = {
                        maxWidth: 300,
                        minWidth: 280,
                        className: place.photoUrl ? 'custom-popup' : 'custom-popup custom-popup-no-photo',
                        closeButton: true
                    };

                    marker.bindPopup(popupHtml, popupOptions);

                    if (markersClusterGroup) markersClusterGroup.addLayer(marker);
                    else marker.addTo(map);
                    
                    markers[place.id] = marker;

                    // Crear Item de Lista (Tarjeta Sidebar)
                    const li = document.createElement('li');
                    li.className = 'bg-white p-4 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition-all duration-200 cursor-pointer group flex gap-3';
                    li.innerHTML = `
                        <div class="flex-shrink-0 w-12 h-12 rounded-lg bg-slate-100 flex items-center justify-center text-xl overflow-hidden">
                            ${place.photoUrl ? `<img src="${place.photoUrl}" class="w-full h-full object-cover">` : `<i class="fas fa-map-marker-alt ${categoryColors[place.category]}"></i>`}
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-slate-800 truncate group-hover:text-brand-primary transition-colors">${place.name}</h4>
                            <div class="flex items-center gap-2 text-xs text-slate-500 mt-0.5">
                                <span>${place.category}</span>
                                ${place.rating > 0 ? `<span class="text-brand-accent">‚òÖ ${place.rating}</span>` : ''}
                            </div>
                        </div>
                        <button class="text-slate-300 hover:text-brand-primary transition-colors" onclick="event.stopPropagation(); openModalForEditing('${place.id}')">
                            <i class="fas fa-pen"></i>
                        </button>
                    `;
                    li.onclick = () => {
                        if (markersClusterGroup && markers[place.id]) {
                            markersClusterGroup.zoomToShowLayer(markers[place.id], () => markers[place.id].openPopup());
                        } else {
                            map.flyTo([place.lat, place.lng], 16);
                            setTimeout(() => markers[place.id]?.openPopup(), 300);
                        }
                        if (window.innerWidth < 768) sidebar.classList.add('-translate-x-full');
                    };
                    placesListElement.appendChild(li);
                });
            }
        }

        function createCustomIcon(category) {
            const colorClass = categoryColors[category] || 'text-slate-500';
            return L.divIcon({
                html: `<i class="fas fa-map-marker-alt fa-3x ${colorClass} drop-shadow-md transform transition-transform hover:scale-110"></i>`,
                className: 'custom-marker-icon',
                iconSize: [30, 42],
                iconAnchor: [15, 42],
                popupAnchor: [0, -45]
            });
        }

        function locateUser() {
            if (!navigator.geolocation) return alert('Geolocalizaci√≥n no soportada.');
            
            locateMeBtn.classList.add('animate-pulse');
            navigator.geolocation.getCurrentPosition(
                pos => {
                    const { latitude, longitude } = pos.coords;
                    map.flyTo([latitude, longitude], 15);
                    
                    if (currentLocationMarker) map.removeLayer(currentLocationMarker);
                    currentLocationMarker = L.marker([latitude, longitude], {
                        icon: L.divIcon({ className: 'current-location-marker', iconSize: [18, 18] })
                    }).addTo(map);
                    
                    locateMeBtn.classList.remove('animate-pulse');
                },
                err => {
                    alert('No se pudo obtener ubicaci√≥n.');
                    locateMeBtn.classList.remove('animate-pulse');
                }
            );
        }

        // Ratings Logic
        function setupRatingStars() {
            placeRatingElement.querySelectorAll('.fa-star').forEach(star => {
                star.onclick = (e) => setRatingStars(e.target.dataset.value);
                star.onmouseover = (e) => highlightStars(e.target.dataset.value);
                star.onmouseout = () => highlightStars(placeRatingValueInput.value);
            });
        }
        function highlightStars(val) {
            placeRatingElement.querySelectorAll('.fa-star').forEach(s => {
                s.classList.toggle('selected', parseInt(s.dataset.value) <= parseInt(val));
            });
        }
        function setRatingStars(val) {
            placeRatingValueInput.value = val;
            highlightStars(val);
        }
        function resetRatingStars() {
            setRatingStars(0);
        }

        // Export/Import
        function exportData() {
            if (!places.length) return alert("Nada que exportar.");
            const blob = new Blob([JSON.stringify(places, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `costarica_lugares_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }
        
        function triggerImport() { importFileInput.click(); }
        
        importFileInput.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const data = JSON.parse(ev.target.result);
                    if (Array.isArray(data)) {
                        if(confirm(`¬øCargar ${data.length} lugares? Esto reemplazar√° los actuales.`)) {
                            places = data;
                            savePlacesToLocalStorage();
                            renderPlaces();
                        }
                    } else alert("Formato inv√°lido");
                } catch (err) { alert("Error al leer archivo"); }
                e.target.value = '';
            };
            reader.readAsText(file);
        };

        // Listeners Iniciales
        window.onload = () => {
            initMap();
            if (map) {
                setupRatingStars();
                toggleListBtn.onclick = () => {
                    sidebar.classList.toggle('-translate-x-full');
                    setTimeout(() => map.invalidateSize(), 300);
                };
                closeSidebarBtn.onclick = () => sidebar.classList.add('-translate-x-full');
                locateMeBtn.onclick = locateUser;
                categoryFilter.onchange = renderPlaces;
                searchInput.oninput = renderPlaces;
                placeForm.onsubmit = savePlace;
                cancelModalBtnHeader.onclick = closeModalAndReset;
                // document.getElementById('cancel-modal-btn-desktop').onclick = closeModalAndReset;
                deletePlaceBtn.onclick = deletePlace;
                sharePlaceBtn.onclick = sharePlace;
                exportBtn.onclick = exportData;
                importBtn.onclick = triggerImport;
                
                // AI Listeners
                magicNotesBtn.onclick = generateMagicNotes;
                aiGuideBtn.onclick = generateTripAdvice;
                closeAiModalBtn.onclick = () => aiModal.classList.add('hidden');
                
                // Click outside modal/sidebar
                document.addEventListener('click', (e) => {
                    if (window.innerWidth < 768 && !sidebar.contains(e.target) && !toggleListBtn.contains(e.target) && !sidebar.classList.contains('-translate-x-full')) {
                        sidebar.classList.add('-translate-x-full');
                    }
                    if (placeModal.contains(e.target) && e.target === placeModal) {
                        closeModalAndReset();
                    }
                    if (aiModal.contains(e.target) && e.target === aiModal) {
                        aiModal.classList.add('hidden');
                    }
                });
            }
        };
    </script>
</body>
</html>
